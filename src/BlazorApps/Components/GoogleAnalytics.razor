@inject NavigationManager Nav
@inject IJSRuntime JS

@using Microsoft.AspNetCore.Components

@if (_markup.HasValue)
{
    @_markup.Value
}

@code {
    [Parameter, EditorRequired]
    public string Id { get; set; } = default!;

    private MarkupString? _markup;

    protected override void OnInitialized()
    {
        Nav.LocationChanged += OnLocationChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !string.IsNullOrWhiteSpace(Id))
        {
            // Send initial page view
            await TrackPageView();
        }
    }

    private async void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        await TrackPageView();
    }

    private async Task TrackPageView()
    {
        var uri = Nav.ToBaseRelativePath(Nav.Uri);
        if (string.IsNullOrEmpty(uri))
            uri = "/";

        await JS.InvokeVoidAsync(
            "gtag",
            "event",
            "page_view",
            new
            {
                page_path = "/" + uri
            }
        );
    }

    public void Dispose()
    {
        Nav.LocationChanged -= OnLocationChanged;
    }

    protected override void OnParametersSet()
    {
        if (string.IsNullOrWhiteSpace(Id))
        {
            _markup = null;
            return;
        }

        _markup = new MarkupString(
            $$"""
              <!-- Google tag (gtag.js) -->
              <script async src="https://www.googletagmanager.com/gtag/js?id={{Id}}"></script>
              <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                gtag('js', new Date());
              
                gtag('config', '{{Id}}');
              </script>
              """);
    }
}
